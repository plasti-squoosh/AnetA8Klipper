# This file contains common pin mappings for the Geeetech GT2560 v3
# board. GT2560 v3 board uses a firmware compiled for the AVR
# atmega2560. For default Geeetech A10 - NOT TESTED - USE AT YOUR OWN RISK!

# Installation: https://www.klipper3d.org/Installation.html
# Look through this document and adjust everything for your needs!
# Always read for first start: https://www.klipper3d.org/Config_checks.html

#[include client.cfg]
[include macros.cfg]
[include mainsail.cfg]

[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0

[virtual_sdcard]
path: /home/lucas/printer_GeeetechA10T_data/gcodes
on_error_gcode: CANCEL_PRINT

[printer]
kinematics: cartesian
max_velocity: 250
max_accel: 10000
max_z_velocity: 20
max_z_accel: 250

[bltouch]
sensor_pin: PC7 #in schematic: Z_MIN1 / Z0_MIN
control_pin: PB5 #in schematic: PB5 / PB5A
x_offset: -45.4
y_offset: -7
#z_offset: 0
speed: 20
samples: 1
sample_retract_dist: 8

[bed_mesh]
speed: 150
mesh_min: 10,0
mesh_max: 150,200
probe_count: 8,8
fade_start: 1
fade_end: 10
fade_target: 0
algorithm: bicubic

[safe_z_home]
home_xy_position: 155.4,117
speed: 50
z_hop: 10
z_hop_speed: 5


[stepper_x]
step_pin: PC0
dir_pin: !PG2
enable_pin: !PC2
microsteps: 16
rotation_distance: 39.85	# Needs adjustment for proper calibration
endstop_pin: ^!PA2
position_endstop: 0
position_max: 220
homing_speed: 40

[stepper_y]
step_pin: PC6
dir_pin: !PC4
enable_pin: !PA7
microsteps: 16
rotation_distance: 39.85	# Needs adjustment for proper calibration
endstop_pin: ^!PA6
position_endstop: 0
position_max: 220
homing_speed: 40

[stepper_z]
step_pin: PA3
dir_pin: PA1
enable_pin: !PA5
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
#endstop_pin: ^!PC7		# Not tested! Be close to an emergency stop for first homing!
#position_endstop: 0
position_max: 230
position_min: -5
homing_speed: 20

[extruder]
step_pin: PL3
dir_pin: PL5
enable_pin: !PB6
microsteps: 16
rotation_distance: 7.619		# Needs to be optimized: https://www.klipper3d.org/Rotation_Distance.html#calibrating-rotation_distance-on-extruders
nozzle_diameter: 0.4
filament_diameter: 1.750
heater_pin: PB4
#heater_pin: PB5
sensor_type: EPCOS 100K B57560G104F		# unknown for default Geeetech A10 extruder, based on fan made Marlin version
sensor_pin: PK3
min_temp: 0
max_temp: 250
min_extrude_temp: 160
max_extrude_only_distance: 150.0
#control: pid
#pid_kp: 30.070
#pid_ki: 1.095
#pid_kd: 206.356

#sensor_type: temperature_combined
#sensor_list:
#   Must be provided. List of sensors to combine to new "virtual"
#   sensor.
#   E.g. 'temperature_sensor sensor1,extruder,heater_bed'
#combination_method:
#   Must be provided. Combination method used for the sensor.
#   Available options are 'max', 'min', 'mean'.
#maximum_deviation:
#   Must be provided. Maximum permissible deviation between the sensors
#   to combine (e.g. 5 degrees). To disable it, use a large value (e.g. 999.9)



[extruder_stepper extruder1]
step_pin: PL0 #in schematic: E0_STEP
dir_pin: PL2 #in schematic: E0_DIR
enable_pin: !PL1 #in schematic: E0_EN
microsteps: 16
rotation_distance: 7.711
extruder: extruder

[extruder_stepper extruder2]
Step_pin: PL6 #in schematic: E0_STEP
dir_pin: PL4 #in schematic: E0_DIR
enable_pin: !PG0 #in schematic: E0_EN
microsteps: 16
rotation_distance: 7.711
extruder: extruder

[gcode_macro T0]
gcode:
    _FAKE_TOOLCHANGE TOOL=0
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    # Deactivate stepper in my_extruder_stepper
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder2 MOTION_QUEUE=
    # Activate stepper in extruder
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder MOTION_QUEUE=extruder

[gcode_macro T1]
gcode:
    _FAKE_TOOLCHANGE TOOL=1
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder MOTION_QUEUE=
    # Activate stepper in my_extruder_stepper
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=extruder
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder2 MOTION_QUEUE=

[gcode_macro T2]
gcode:
    _FAKE_TOOLCHANGE TOOL=2
    ACTIVATE_EXTRUDER EXTRUDER=extruder
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder MOTION_QUEUE=
    # Activate stepper in my_extruder_stepper
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder1 MOTION_QUEUE=
    SYNC_EXTRUDER_MOTION EXTRUDER=extruder2 MOTION_QUEUE=extruder

[heater_bed]
heater_pin: PG5
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PK2
min_temp: 0
max_temp: 120
#control: pid	# Run pid tuning! https://www.klipper3d.org/Config_checks.html#calibrate-pid-settings
#pid_Kp: 182.46
#pid_Ki: 35.92
#pid_Kd: 231.70


[fan]
pin: PH6
cycle_time: 0.150
kick_start_time: 0.300
max_power: 1



[display]
lcd_type: hd44780
rs_pin: PD1 #in schematic: LCM_RS
e_pin: PH0 #in schematic: LCM_EN
d4_pin: PH1 #in schematic: LCM_D4
d5_pin: PD0 #in schematic: LCM_D5
d6_pin: PE3 #in schematic: LCM_D6
d7_pin: PC1 #in schematic: LCM_D7
encoder_pins: PL7, PG1
click_pin: PD2 #in schematic: EC_PRESS

#[display]
#lcd_type: hd44780_spi
#   Set to "hd44780_spi" for hd44780_spi displays.
#latch_pin: PB0
#spi_software_sclk_pin: PB1
#spi_software_mosi_pin: PB2
#spi_software_miso_pin: PB3
#   The pins connected to the shift register controlling the display.
#   The spi_software_miso_pin needs to be set to an unused pin of the
#   printer mainboard as the shift register does not have a MISO pin,
#   but the software spi implementation requires this pin to be
#   configured.
#hd44780_protocol_init: false
#   Perform 8-bit/4-bit protocol initialization on an hd44780 display.
#   This is necessary on real hd44780 devices. However, one may need
#   to disable this on some "clone" devices. The default is True.
#line_length: 20
#   Set the number of characters per line for an hd44780 type lcd.
#   Possible values are 20 (default) and 16. The number of lines is
#   fixed to 4.



[filament_switch_sensor filament0]			# Not tested!
pause_on_runout: True
switch_pin: ^!PK4
runout_gcode:
    PAUSE_MACRO
insert_gcode:
    RESUME_MACRO

[filament_switch_sensor filament1]			# Not tested!
pause_on_runout: True
switch_pin: ^!PK5
runout_gcode:
    PAUSE_MACRO
insert_gcode:
    RESUME_MACRO

[filament_switch_sensor filament2]			# Not tested!
pause_on_runout: True
switch_pin: ^!PF0
runout_gcode:
    PAUSE_MACRO
insert_gcode:
    RESUME_MACRO

[verify_heater extruder]
max_error: 3000
#   The maximum "cumulative temperature error" before raising an
#   error. Smaller values result in stricter checking and larger
#   values allow for more time before an error is reported.
#   Specifically, the temperature is inspected once a second and if it
#   is close to the target temperature then an internal "error
#   counter" is reset; otherwise, if the temperature is below the
#   target range then the counter is increased by the amount the
#   reported temperature differs from that range. Should the counter
#   exceed this "max_error" then an error is raised. The default is
#   120.
check_gain_time: 120
#   This controls heater verification during initial heating. Smaller
#   values result in stricter checking and larger values allow for
#   more time before an error is reported. Specifically, during
#   initial heating, as long as the heater increases in temperature
#   within this time frame (specified in seconds) then the internal
#   "error counter" is reset. The default is 20 seconds for extruders
#   and 60 seconds for heater_bed.
hysteresis: 5
#   The maximum temperature difference (in Celsius) to a target
#   temperature that is considered in range of the target. This
#   controls the max_error range check. It is rare to customize this
#   value. The default is 5.
heating_gain: .5
#   The minimum temperature (in Celsius) that the heater must increase
#   by during the check_gain_time check. It is rare to customize this
#   value. The default is 2.

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [stepper_z]
#*# position_endstop = 0.050
#*#
#*# [bltouch]
#*# z_offset = 1.730
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 31.550
#*# pid_ki = 1.492
#*# pid_kd = 166.823
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 62.272
#*# pid_ki = 1.634
#*# pid_kd = 593.140
